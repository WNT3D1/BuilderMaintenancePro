{% extends "base.html" %}

{% block title %}Reports - Builders Maintenance Management{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<!-- Existing HTML content remains unchanged -->
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    $('#maintenance_class, #priority, #status').select2({
        theme: 'bootstrap-5',
        width: '100%'
    });

    const filterForm = document.getElementById('filter-form');
    const resetFiltersBtn = document.getElementById('reset-filters');
    
    filterForm.addEventListener('submit', function(event) {
        event.preventDefault();
        fetchFilteredReports();
    });

    resetFiltersBtn.addEventListener('click', function() {
        filterForm.reset();
        $('#maintenance_class, #priority, #status').val(null).trigger('change');
        fetchFilteredReports();
    });

    // Initial load of reports
    fetchFilteredReports();
});

function fetchFilteredReports() {
    const filterForm = document.getElementById('filter-form');
    const formData = new FormData(filterForm);
    const queryString = new URLSearchParams(formData).toString();

    fetch(`/filtered_reports?${queryString}`)
        .then(response => response.json())
        .then(data => {
            updateReportTables(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function updateReportTables(data) {
    // Update Maintenance Logs
    const maintenanceLogsTable = document.getElementById('maintenance-logs-table');
    maintenanceLogsTable.innerHTML = '';
    data.maintenance_logs.forEach(log => {
        const row = `<tr>
            <td>${log.date}</td>
            <td>${log.lot_number}</td>
            <td>${log.maintenance_class}</td>
            <td>${log.description}</td>
        </tr>`;
        maintenanceLogsTable.innerHTML += row;
    });

    // Update Work Orders
    const workOrdersTable = document.getElementById('work-orders-table');
    workOrdersTable.innerHTML = '';
    data.work_orders.forEach(order => {
        const row = `<tr>
            <td>${order.id}</td>
            <td>${order.status}</td>
            <td>${order.priority}</td>
            <td>${order.scheduled_date}</td>
            <td>${order.assigned_to}</td>
            <td>${order.is_critical ? 'Yes' : 'No'}</td>
        </tr>`;
        workOrdersTable.innerHTML += row;
    });

    // Update statistics
    document.getElementById('total-logs').textContent = data.total_logs;
    document.getElementById('total-orders').textContent = data.total_orders;
    document.getElementById('completed-orders').textContent = data.completed_orders;
    document.getElementById('completion-rate').textContent = data.completion_rate.toFixed(2);
}
</script>
{% endblock %}
